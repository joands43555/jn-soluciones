<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#002d5e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Sistema profesional de gestión de préstamos y cobranzas">
    <title>J&N SOLUCIONES PRO - Gestión Financiera</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002d5e',
                        accent: '#00a8e8',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        dark: '#0b0f19',
                        card: '#1a2233',
                        surface: '#0f172a'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin; 
            scrollbar-color: #334155 #0f172a; 
        }
        *::-webkit-scrollbar { width: 4px; }
        *::-webkit-scrollbar-track { background: #0f172a; }
        *::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0b0f19; 
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }
        
        .glass-effect {
            background: rgba(26, 34, 51, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #00a8e8 0%, #002d5e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:active {
            transform: scale(0.98);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #002d5e 0%, #00a8e8 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .notification {
            animation: slideDown 0.4s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #00a8e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(26, 34, 51, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(0, 168, 232, 0.2);
            overflow: hidden;
        }
        
        .stat-value {
            font-size: clamp(1rem, 4vw, 1.5rem);
            word-break: break-all;
            line-height: 1.2;
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        .menu-item:hover {
            background: rgba(0, 168, 232, 0.1);
            border-left: 3px solid #00a8e8;
        }
        .menu-item.active {
            background: linear-gradient(90deg, rgba(0, 168, 232, 0.2) 0%, transparent 100%);
            border-left: 3px solid #00a8e8;
            color: #00a8e8;
        }
        
        .input-focus:focus {
            outline: none;
            border-color: #00a8e8;
            box-shadow: 0 0 0 3px rgba(0, 168, 232, 0.2);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-overdue { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-blacklist { background: rgba(0, 0, 0, 0.4); color: #9ca3af; }
        
        /* PIN Pad Styles */
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .pin-dot.filled {
            background: #00a8e8;
            box-shadow: 0 0 10px rgba(0, 168, 232, 0.5);
        }
        .pin-dot.error {
            background: #ef4444;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .pin-key {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }
        .pin-key:active {
            background: rgba(0, 168, 232, 0.3);
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .mobile-menu {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                background: rgba(26, 34, 51, 0.98);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .mobile-nav {
                padding: 8px 4px;
                min-height: 56px;
            }
            
            .content-area {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
            
            .pin-key {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            
            .stat-value {
                font-size: clamp(0.875rem, 3.5vw, 1.25rem);
            }
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        
        /* Voucher with background image */
        .voucher-container {
            position: relative;
            width: 350px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .voucher-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.15;
            pointer-events: none;
        }
        
        .voucher-content {
            position: relative;
            z-index: 1;
            padding: 30px;
            font-family: Arial, sans-serif;
            color: #1f2937;
        }
        
        .voucher-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin: 0 auto 10px;
            display: block;
        }
        
        .touch-feedback {
            position: relative;
            overflow: hidden;
        }
        .touch-feedback::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .touch-feedback:active::after {
            width: 200%;
            height: 200%;
        }
        
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: #000;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        /* Voucher gallery */
        .voucher-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .voucher-thumb {
            aspect-ratio: 1;
            background: #1a2233;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .voucher-thumb:hover {
            border-color: #00a8e8;
        }
        .voucher-thumb i {
            font-size: 32px;
            color: #00a8e8;
            margin-bottom: 8px;
        }
        .voucher-thumb span {
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            padding: 0 8px;
        }
        
        /* Modal improvements */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        /* Number formatting */
        .truncate-number {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
    </style>
<base target="_blank">
</head>
<body class="text-gray-100 min-h-screen">
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash mr-2"></i> Sin conexión - Modo offline activo
    </div>

    <!-- Login Screen with PIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-br from-dark via-card to-dark p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-accent/30">
                    <i class="fas fa-chart-line text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-black gradient-text mb-2">J&N SOLUCIONES</h1>
                <p class="text-gray-400 text-sm">Ingrese su PIN de acceso</p>
            </div>
            
            <!-- PIN Display -->
            <div class="flex justify-center gap-4 mb-8">
                <div class="pin-dot" id="pin-1"></div>
                <div class="pin-dot" id="pin-2"></div>
                <div class="pin-dot" id="pin-3"></div>
                <div class="pin-dot" id="pin-4"></div>
            </div>
            
            <!-- PIN Pad -->
            <div class="grid grid-cols-3 gap-4 max-w-[240px] mx-auto mb-6">
                <button class="pin-key touch-feedback" onclick="enterPin(1)">1</button>
                <button class="pin-key touch-feedback" onclick="enterPin(2)">2</button>
                <button class="pin-key touch-feedback" onclick="enterPin(3)">3</button>
                <button class="pin-key touch-feedback" onclick="enterPin(4)">4</button>
                <button class="pin-key touch-feedback" onclick="enterPin(5)">5</button>
                <button class="pin-key touch-feedback" onclick="enterPin(6)">6</button>
                <button class="pin-key touch-feedback" onclick="enterPin(7)">7</button>
                <button class="pin-key touch-feedback" onclick="enterPin(8)">8</button>
                <button class="pin-key touch-feedback" onclick="enterPin(9)">9</button>
                <button class="pin-key touch-feedback text-danger" onclick="clearPin()">
                    <i class="fas fa-times"></i>
                </button>
                <button class="pin-key touch-feedback" onclick="enterPin(0)">0</button>
                <button class="pin-key touch-feedback text-accent" onclick="deletePin()">
                    <i class="fas fa-backspace"></i>
                </button>
            </div>
            
            <p id="pin-error" class="text-danger text-center text-sm mb-4 opacity-0 transition-opacity">PIN incorrecto</p>
            
            <button onclick="loginDemo()" class="w-full py-3 text-gray-500 text-sm hover:text-accent transition-colors">
                <i class="fas fa-user-shield mr-2"></i> Modo Demo (Sin conexión)
            </button>
            
            <p class="text-xs text-gray-600 text-center mt-6">Versión PRO 2026</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden min-h-screen flex flex-col lg:flex-row">
        <!-- Sidebar (Desktop) -->
        <aside class="hidden lg:flex w-72 flex-col glass-effect border-r border-gray-800 fixed h-full z-30">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-white">J&N PRO</h2>
                        <p class="text-xs text-gray-400">v2026.1</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="showPage('dashboard')" id="nav-dashboard" class="menu-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left touch-feedback">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="showPage('clients')" id="nav-clients" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-users w-5"></i> Clientes
                </button>
                <button onclick="showPage('loans')" id="nav-loans" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-hand-holding-usd w-5"></i> Préstamos
                </button>
                <button onclick="showPage('payments')" id="nav-payments" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-money-bill-wave w-5"></i> Cobros
                </button>
                <button onclick="showPage('vouchers')" id="nav-vouchers" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-receipt w-5"></i> Comprobantes
                </button>
                <button onclick="showPage('blacklist')" id="nav-blacklist" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-ban w-5"></i> Lista Negra
                </button>
                <button onclick="showPage('reports')" id="nav-reports" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-chart-pie w-5"></i> Reportes
                </button>
                <button onclick="showPage('settings')" id="nav-settings" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-400 touch-feedback">
                    <i class="fas fa-cog w-5"></i> Configuración
                </button>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <div class="flex items-center gap-3 mb-3">
                    <div id="sync-status-dot" class="w-2 h-2 rounded-full bg-success pulse-ring"></div>
                    <span id="sync-status-text" class="text-xs text-gray-400">Sincronizado</span>
                </div>
                <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-2 rounded-lg bg-danger/20 text-danger text-sm hover:bg-danger/30 transition-all touch-feedback">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-h-screen lg:ml-72 content-area">
            <!-- Header -->
            <header class="glass-effect border-b border-gray-800 px-4 md:px-6 py-4 flex items-center justify-between sticky top-0 z-40 safe-top">
                <div class="flex items-center gap-3">
                    <button class="lg:hidden text-gray-400 p-2 -ml-2" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 id="page-title" class="text-lg md:text-xl font-bold">Dashboard</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="showNotifications()" class="relative p-2 text-gray-400 hover:text-white transition-all touch-feedback">
                        <i class="fas fa-bell text-lg md:text-xl"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 w-5 h-5 bg-danger rounded-full text-xs flex items-center justify-center hidden">0</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-accent to-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <span id="user-name" class="hidden sm:block text-sm font-medium">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 p-4 md:p-6 overflow-auto">
                <!-- Dashboard -->
                <div id="page-dashboard" class="view space-y-4 md:space-y-6">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <div class="stat-card rounded-2xl p-3 md:p-6 card-hover touch-feedback">
                            <div class="flex items-center justify-between mb-2 md:mb-4">
                                <div class="w-8 h-8 md:w-12 md:h-12 bg-danger/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-wallet text-danger text-sm md:text-xl"></i>
                                </div>
                                <span class="text-[10px] md:text-xs text-gray-500">Capital</span>
                            </div>
                            <p class="stat-value font-black text-white truncate-number" id="stat-capital">$0</p>
                            <p class="text-[10px] md:text-xs text-gray-500 mt-1">En calle</p>
                        </div>
                        
                        <div class="stat-card rounded-2xl p-3 md:p-6 card-hover touch-feedback">
                            <div class="flex items-center justify-between mb-2 md:mb-4">
                                <div class="w-8 h-8 md:w-12 md:h-12 bg-success/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-chart-line text-success text-sm md:text-xl"></i>
                                </div>
                                <span class="text-[10px] md:text-xs text-gray-500">Ganancias</span>
                            </div>
                            <p class="stat-value font-black text-success truncate-number" id="stat-profits">$0</p>
                            <p class="text-[10px] md:text-xs text-gray-500 mt-1">Intereses</p>
                        </div>
                        
                        <div class="stat-card rounded-2xl p-3 md:p-6 card-hover touch-feedback">
                            <div class="flex items-center justify-between mb-2 md:mb-4">
                                <div class="w-8 h-8 md:w-12 md:h-12 bg-accent/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-users text-accent text-sm md:text-xl"></i>
                                </div>
                                <span class="text-[10px] md:text-xs text-gray-500">Clientes</span>
                            </div>
                            <p class="text-lg md:text-2xl font-black text-white" id="stat-clients">0</p>
                            <p class="text-[10px] md:text-xs text-gray-500 mt-1">Activos</p>
                        </div>
                        
                        <div class="stat-card rounded-2xl p-3 md:p-6 card-hover touch-feedback">
                            <div class="flex items-center justify-between mb-2 md:mb-4">
                                <div class="w-8 h-8 md:w-12 md:h-12 bg-warning/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-warning text-sm md:text-xl"></i>
                                </div>
                                <span class="text-[10px] md:text-xs text-gray-500">Vencidos</span>
                            </div>
                            <p class="text-lg md:text-2xl font-black text-warning" id="stat-overdue">0</p>
                            <p class="text-[10px] md:text-xs text-gray-500 mt-1">Préstamos</p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <div class="glass-effect rounded-2xl p-4 md:p-6">
                            <h3 class="text-base md:text-lg font-bold mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-area text-accent"></i> Evolución
                            </h3>
                            <div class="chart-container">
                                <canvas id="chart-evolution"></canvas>
                            </div>
                        </div>
                        
                        <div class="glass-effect rounded-2xl p-4 md:p-6">
                            <h3 class="text-base md:text-lg font-bold mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-pie text-accent"></i> Distribución
                            </h3>
                            <div class="chart-container">
                                <canvas id="chart-distribution"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-base md:text-lg font-bold flex items-center gap-2">
                                <i class="fas fa-history text-accent"></i> Actividad Reciente
                            </h3>
                            <button onclick="showPage('payments')" class="text-sm text-accent hover:underline">Ver todo</button>
                        </div>
                        <div id="recent-activity" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No hay actividad reciente</p>
                        </div>
                    </div>
                </div>

                <!-- Clients -->
                <div id="page-clients" class="view hidden space-y-4 md:space-y-6">
                    <div class="flex flex-col sm:flex-row gap-3 justify-between items-start sm:items-center">
                        <div class="relative flex-1 max-w-md w-full">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            <input type="text" id="search-clients" placeholder="Buscar cliente..." 
                                class="w-full pl-12 pr-4 py-3 bg-surface border border-gray-700 rounded-xl text-white placeholder-gray-500 input-focus text-base"
                                onkeyup="searchClients()">
                        </div>
                        <button onclick="openModal('modal-new-client')" class="btn-gradient px-4 md:px-6 py-3 rounded-xl font-bold text-white flex items-center gap-2 touch-feedback w-full sm:w-auto justify-center">
                            <i class="fas fa-plus"></i> <span class="hidden sm:inline">Nuevo Cliente</span><span class="sm:hidden">Nuevo</span>
                        </button>
                    </div>
                    
                    <div id="clients-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4">
                        <!-- Clients will be rendered here -->
                    </div>
                </div>

                <!-- Loans -->
                <div id="page-loans" class="view hidden space-y-4 md:space-y-6">
                    <div class="flex flex-col sm:flex-row gap-3 justify-between items-start sm:items-center">
                        <div class="flex gap-2 overflow-x-auto pb-2 sm:pb-0 w-full sm:w-auto">
                            <button onclick="filterLoans('all')" class="filter-btn active px-3 md:px-4 py-2 rounded-lg bg-accent/20 text-accent text-sm font-medium whitespace-nowrap" data-filter="all">Todos</button>
                            <button onclick="filterLoans('active')" class="filter-btn px-3 md:px-4 py-2 rounded-lg bg-surface text-gray-400 text-sm font-medium whitespace-nowrap" data-filter="active">Activos</button>
                            <button onclick="filterLoans('overdue')" class="filter-btn px-3 md:px-4 py-2 rounded-lg bg-surface text-gray-400 text-sm font-medium whitespace-nowrap" data-filter="overdue">Vencidos</button>
                        </div>
                        <button onclick="openModal('modal-new-loan')" class="btn-gradient px-4 md:px-6 py-3 rounded-xl font-bold text-white flex items-center gap-2 touch-feedback w-full sm:w-auto justify-center">
                            <i class="fas fa-plus"></i> <span class="hidden sm:inline">Nuevo Préstamo</span><span class="sm:hidden">Nuevo</span>
                        </button>
                    </div>
                    
                    <div id="loans-grid" class="space-y-3 md:space-y-4">
                        <!-- Loans will be rendered here -->
                    </div>
                </div>

                <!-- Payments -->
                <div id="page-payments" class="view hidden space-y-4 md:space-y-6">
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-4 md:mb-6">Registrar Pago</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Seleccionar Cliente</label>
                                <select id="payment-client" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" onchange="loadClientLoans()">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Préstamo</label>
                                <select id="payment-loan" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" onchange="calculatePayment()">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Interés (10%)</label>
                                <input type="number" id="payment-interest" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" readonly>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Abono a Capital</label>
                                <input type="number" id="payment-capital" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Próxima Fecha</label>
                                <input type="date" id="payment-next-date" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base">
                            </div>
                            <div class="flex items-end">
                                <button onclick="processPayment()" class="w-full btn-gradient py-3 rounded-xl font-bold text-white touch-feedback">
                                    <i class="fas fa-check mr-2"></i> Procesar Pago
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-4">Historial de Pagos</h3>
                        <div id="payments-history" class="overflow-x-auto -mx-4 px-4">
                            <table class="w-full min-w-[600px]">
                                <thead>
                                    <tr class="text-left text-gray-400 border-b border-gray-700 text-sm">
                                        <th class="pb-3">Fecha</th>
                                        <th class="pb-3">Cliente</th>
                                        <th class="pb-3">Interés</th>
                                        <th class="pb-3">Capital</th>
                                        <th class="pb-3">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body">
                                    <!-- Payments will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vouchers Page -->
                <div id="page-vouchers" class="view hidden space-y-4 md:space-y-6">
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4 md:mb-6">
                            <div>
                                <h3 class="text-base md:text-lg font-bold flex items-center gap-2">
                                    <i class="fas fa-receipt text-accent"></i> Comprobantes Generados
                                </h3>
                                <p class="text-xs md:text-sm text-gray-400 mt-1">Los vouchers se guardan localmente en tu dispositivo</p>
                            </div>
                            <button onclick="generateTestVoucher()" class="px-4 py-2 bg-accent/20 text-accent rounded-lg text-sm hover:bg-accent/30 touch-feedback">
                                <i class="fas fa-plus mr-2"></i> Generar Test
                            </button>
                        </div>
                        
                        <div id="vouchers-list" class="voucher-gallery">
                            <!-- Vouchers will be listed here -->
                        </div>
                        
                        <div id="no-vouchers" class="text-center py-12">
                            <div class="w-16 h-16 bg-surface rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-receipt text-2xl text-gray-600"></i>
                            </div>
                            <p class="text-gray-500">No hay comprobantes guardados</p>
                            <p class="text-xs text-gray-600 mt-2">Los vouchers se generan automáticamente al crear préstamos o recibir pagos</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-4 md:p-6 border border-gray-700">
                        <h4 class="font-bold mb-4 flex items-center gap-2">
                            <i class="fas fa-info-circle text-accent"></i> Información Importante
                        </h4>
                        <div class="space-y-3 text-sm text-gray-400">
                            <p><i class="fas fa-mobile-alt mr-2 text-accent"></i> <strong>En móvil:</strong> Los vouchers se descargan a tu carpeta de Descargas o se abren en una nueva pestaña para que los guardes manualmente.</p>
                            <p><i class="fas fa-share-alt mr-2 text-accent"></i> <strong>Compartir:</strong> Puedes compartir directamente por WhatsApp desde el botón de compartir.</p>
                            <p><i class="fas fa-desktop mr-2 text-accent"></i> <strong>En PC:</strong> Se descargan automáticamente a la carpeta de Descargas.</p>
                        </div>
                    </div>
                </div>

                <!-- Blacklist -->
                <div id="page-blacklist" class="view hidden space-y-4 md:space-y-6">
                    <div class="glass-effect rounded-2xl p-4 md:p-6 border border-danger/30">
                        <div class="flex items-center gap-3 mb-4 md:mb-6">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-danger/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-ban text-danger text-lg md:text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-base md:text-lg font-bold text-danger">Lista Negra</h3>
                                <p class="text-xs md:text-sm text-gray-400">Clientes bloqueados por morosidad</p>
                            </div>
                        </div>
                        <div id="blacklist-grid" class="space-y-3 md:space-y-4">
                            <!-- Blacklist items will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Reports -->
                <div id="page-reports" class="view hidden space-y-4 md:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                        <button onclick="generateReport('daily')" class="glass-effect rounded-2xl p-4 md:p-6 text-left card-hover border border-gray-700 hover:border-accent/50 touch-feedback">
                            <i class="fas fa-calendar-day text-accent text-xl md:text-2xl mb-3"></i>
                            <h4 class="font-bold text-sm md:text-base">Reporte Diario</h4>
                            <p class="text-xs md:text-sm text-gray-400">Resumen de hoy</p>
                        </button>
                        <button onclick="generateReport('weekly')" class="glass-effect rounded-2xl p-4 md:p-6 text-left card-hover border border-gray-700 hover:border-accent/50 touch-feedback">
                            <i class="fas fa-calendar-week text-accent text-xl md:text-2xl mb-3"></i>
                            <h4 class="font-bold text-sm md:text-base">Reporte Semanal</h4>
                            <p class="text-xs md:text-sm text-gray-400">Últimos 7 días</p>
                        </button>
                        <button onclick="generateReport('monthly')" class="glass-effect rounded-2xl p-4 md:p-6 text-left card-hover border border-gray-700 hover:border-accent/50 touch-feedback">
                            <i class="fas fa-calendar-alt text-accent text-xl md:text-2xl mb-3"></i>
                            <h4 class="font-bold text-sm md:text-base">Reporte Mensual</h4>
                            <p class="text-xs md:text-sm text-gray-400">Este mes</p>
                        </button>
                    </div>
                    
                    <div id="report-content" class="glass-effect rounded-2xl p-4 md:p-6 hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 md:mb-6">
                            <h3 id="report-title" class="text-base md:text-lg font-bold"></h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="exportReportPDF()" class="flex-1 sm:flex-none px-3 md:px-4 py-2 bg-danger/20 text-danger rounded-lg text-xs md:text-sm font-medium hover:bg-danger/30 touch-feedback">
                                    <i class="fas fa-file-pdf mr-1 md:mr-2"></i> PDF
                                </button>
                                <button onclick="shareReport()" class="flex-1 sm:flex-none px-3 md:px-4 py-2 bg-success/20 text-success rounded-lg text-xs md:text-sm font-medium hover:bg-success/30 touch-feedback">
                                    <i class="fas fa-share-alt mr-1 md:mr-2"></i> Compartir
                                </button>
                            </div>
                        </div>
                        <div id="report-data" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Settings -->
                <div id="page-settings" class="view hidden space-y-4 md:space-y-6">
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <i class="fas fa-lock text-accent"></i> Cambiar PIN de Acceso
                        </h3>
                        <div class="max-w-md space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">PIN Actual</label>
                                <input type="password" id="current-pin" maxlength="4" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base tracking-widest" placeholder="••••">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Nuevo PIN (4 dígitos)</label>
                                <input type="password" id="new-pin" maxlength="4" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base tracking-widest" placeholder="••••">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Confirmar Nuevo PIN</label>
                                <input type="password" id="confirm-pin" maxlength="4" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base tracking-widest" placeholder="••••">
                            </div>
                            <button onclick="changePin()" class="w-full btn-gradient py-3 rounded-xl font-bold text-white touch-feedback">
                                <i class="fas fa-save mr-2"></i> Cambiar PIN
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <i class="fas fa-database text-accent"></i> Backup y Restauración
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                            <button onclick="exportData()" class="p-4 md:p-6 bg-surface rounded-xl border border-gray-700 hover:border-accent/50 transition-all text-left touch-feedback">
                                <i class="fas fa-download text-accent text-xl md:text-2xl mb-3"></i>
                                <h4 class="font-bold text-sm md:text-base">Exportar Datos</h4>
                                <p class="text-xs md:text-sm text-gray-400">Descargar backup JSON</p>
                            </button>
                            <label class="p-4 md:p-6 bg-surface rounded-xl border border-gray-700 hover:border-accent/50 transition-all text-left cursor-pointer touch-feedback">
                                <i class="fas fa-upload text-accent text-xl md:text-2xl mb-3"></i>
                                <h4 class="font-bold text-sm md:text-base">Importar Datos</h4>
                                <p class="text-xs md:text-sm text-gray-400">Restaurar desde archivo</p>
                                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData()">
                            </label>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <i class="fas fa-percentage text-accent"></i> Configuración de Tasas
                        </h3>
                        <div class="max-w-md">
                            <label class="block text-sm text-gray-400 mb-2">Tasa de Interés Predeterminada (%)</label>
                            <div class="flex gap-2">
                                <input type="number" id="settings-rate" value="10" class="flex-1 px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base">
                                <button onclick="saveSettings()" class="btn-gradient px-4 md:px-6 py-3 rounded-xl font-bold text-white touch-feedback">Guardar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-4 md:p-6 border border-danger/30">
                        <h3 class="text-base md:text-lg font-bold mb-4 md:mb-6 text-danger flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i> Zona de Peligro
                        </h3>
                        <button onclick="resetAllData()" class="w-full md:w-auto px-4 md:px-6 py-3 bg-danger/20 text-danger rounded-xl font-medium hover:bg-danger/30 transition-all touch-feedback text-sm md:text-base">
                            <i class="fas fa-trash-alt mr-2"></i> Reiniciar Todos los Datos
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Menu -->
        <nav class="mobile-menu lg:hidden flex justify-around p-2">
            <button onclick="showPage('dashboard')" class="mobile-nav flex flex-col items-center gap-1 text-accent px-2" data-page="dashboard">
                <i class="fas fa-home text-lg"></i>
                <span class="text-[10px]">Inicio</span>
            </button>
            <button onclick="showPage('clients')" class="mobile-nav flex flex-col items-center gap-1 text-gray-400 px-2" data-page="clients">
                <i class="fas fa-users text-lg"></i>
                <span class="text-[10px]">Clientes</span>
            </button>
            <button onclick="showPage('loans')" class="mobile-nav flex flex-col items-center gap-1 text-gray-400 px-2" data-page="loans">
                <i class="fas fa-hand-holding-usd text-lg"></i>
                <span class="text-[10px]">Préstamos</span>
            </button>
            <button onclick="showPage('vouchers')" class="mobile-nav flex flex-col items-center gap-1 text-gray-400 px-2" data-page="vouchers">
                <i class="fas fa-receipt text-lg"></i>
                <span class="text-[10px]">Vouchers</span>
            </button>
            <button onclick="toggleMoreMenu()" class="mobile-nav flex flex-col items-center gap-1 text-gray-400 px-2" data-page="more" id="btn-more">
                <i class="fas fa-ellipsis-h text-lg"></i>
                <span class="text-[10px]">Más</span>
            </button>
        </nav>
    </div>

    <!-- Mobile More Menu Modal -->
    <div id="modal-more" class="fixed inset-0 z-50 hidden items-end justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300" onclick="handleMoreBackdropClick(event)">
        <div class="glass-effect rounded-t-3xl p-6 w-full max-w-sm mx-auto slide-in safe-bottom transform transition-transform duration-300" id="more-menu-content">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6"></div>
            <div class="space-y-2">
                <button onclick="showPage('payments'); toggleMoreMenu()" class="w-full flex items-center gap-4 px-4 py-4 rounded-xl hover:bg-white/5 text-left touch-feedback">
                    <div class="w-10 h-10 bg-accent/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-accent"></i>
                    </div>
                    <span class="font-medium">Cobros</span>
                </button>
                <button onclick="showPage('blacklist'); toggleMoreMenu()" class="w-full flex items-center gap-4 px-4 py-4 rounded-xl hover:bg-white/5 text-left touch-feedback">
                    <div class="w-10 h-10 bg-danger/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-ban text-danger"></i>
                    </div>
                    <span class="font-medium">Lista Negra</span>
                </button>
                <button onclick="showPage('reports'); toggleMoreMenu()" class="w-full flex items-center gap-4 px-4 py-4 rounded-xl hover:bg-white/5 text-left touch-feedback">
                    <div class="w-10 h-10 bg-accent/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-pie text-accent"></i>
                    </div>
                    <span class="font-medium">Reportes</span>
                </button>
                <button onclick="showPage('settings'); toggleMoreMenu()" class="w-full flex items-center gap-4 px-4 py-4 rounded-xl hover:bg-white/5 text-left touch-feedback">
                    <div class="w-10 h-10 bg-gray-700 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cog text-gray-300"></i>
                    </div>
                    <span class="font-medium">Configuración</span>
                </button>
            </div>
            <button onclick="toggleMoreMenu()" class="w-full mt-4 py-3 bg-surface rounded-xl text-gray-400 font-medium touch-feedback">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-new-client" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4 overflow-y-auto" onclick="if(event.target === this) closeModal('modal-new-client')">
        <div class="glass-effect rounded-2xl p-6 w-full max-w-md mx-auto slide-in my-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg md:text-xl font-bold">Nuevo Cliente</h3>
                <button onclick="closeModal('modal-new-client')" class="text-gray-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Nombre Completo *</label>
                    <input type="text" id="new-client-name" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" placeholder="Ej: Juan Pérez">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cédula / ID</label>
                    <input type="text" id="new-client-id" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" placeholder="Ej: 001-0000000-0">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Teléfono *</label>
                    <input type="tel" id="new-client-phone" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" placeholder="Ej: 809-000-0000">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Dirección (Opcional)</label>
                    <textarea id="new-client-address" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus resize-none text-base" rows="2" placeholder="Dirección del cliente"></textarea>
                </div>
                <button onclick="saveNewClient()" class="w-full btn-gradient py-3 rounded-xl font-bold text-white mt-4 touch-feedback">
                    <i class="fas fa-save mr-2"></i> Guardar Cliente
                </button>
            </div>
        </div>
    </div>

    <div id="modal-new-loan" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4 overflow-y-auto" onclick="if(event.target === this) closeModal('modal-new-loan')">
        <div class="glass-effect rounded-2xl p-6 w-full max-w-md mx-auto slide-in my-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg md:text-xl font-bold">Nuevo Préstamo</h3>
                <button onclick="closeModal('modal-new-loan')" class="text-gray-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cliente *</label>
                    <select id="new-loan-client" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base">
                        <option value="">Seleccionar cliente...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Monto del Préstamo *</label>
                    <input type="number" id="new-loan-amount" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base" placeholder="$0.00">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Tasa de Interés (%)</label>
                    <input type="number" id="new-loan-rate" value="10" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Fecha Primer Pago *</label>
                    <input type="date" id="new-loan-date" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus text-base">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Notas (Opcional)</label>
                    <textarea id="new-loan-notes" class="w-full px-4 py-3 bg-surface border border-gray-700 rounded-xl text-white input-focus resize-none text-base" rows="2" placeholder="Notas adicionales"></textarea>
                </div>
                <button onclick="saveNewLoan()" class="w-full btn-gradient py-3 rounded-xl font-bold text-white mt-4 touch-feedback">
                    <i class="fas fa-hand-holding-usd mr-2"></i> Crear Préstamo
                </button>
            </div>
        </div>
    </div>

    <div id="modal-loan-details" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="if(event.target === this) closeModal('modal-loan-details')">
        <div class="glass-effect rounded-2xl p-6 w-full max-w-lg mx-auto slide-in max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg md:text-xl font-bold">Detalles del Préstamo</h3>
                <button onclick="closeModal('modal-loan-details')" class="text-gray-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="loan-details-content"></div>
        </div>
    </div>

    <!-- Voucher Preview Modal -->
    <div id="modal-voucher-preview" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-sm p-4" onclick="if(event.target === this) closeModal('modal-voucher-preview')">
        <div class="bg-white rounded-2xl p-4 w-full max-w-md mx-auto slide-in">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-lg font-bold text-gray-800">Vista Previa</h3>
                <button onclick="closeModal('modal-voucher-preview')" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="voucher-preview-container" class="mb-4 flex justify-center">
                <!-- Voucher image will be inserted here -->
            </div>
            <div class="flex gap-2">
                <button onclick="downloadCurrentVoucher()" class="flex-1 btn-gradient py-3 rounded-xl font-bold text-white touch-feedback">
                    <i class="fas fa-download mr-2"></i> Descargar
                </button>
                <button onclick="shareCurrentVoucher()" class="flex-1 bg-success py-3 rounded-xl font-bold text-white touch-feedback">
                    <i class="fas fa-share-alt mr-2"></i> Compartir
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 left-4 md:left-auto z-[60] space-y-2 pointer-events-none"></div>

    <!-- Voucher Template with Background -->
    <div id="voucher-template" class="hidden fixed top-0 left-0 z-[-1]">
        <div class="voucher-container" id="voucher-element">
            <!-- Background Image - Replace with your image URL -->
            <img src="https://i.imgur.com/placeholder-bg.jpg" class="voucher-bg" id="voucher-bg-img" alt="background">
            
            <div class="voucher-content">
                <!-- Logo - Replace with your logo URL -->
                <img src="https://i.imgur.com/placeholder-logo.png" class="voucher-logo" id="voucher-logo-img" alt="J&N Soluciones">
                
                <div class="text-center border-b-2 border-primary pb-2 mb-4">
                    <h2 style="color: #002d5e; font-size: 20px; font-weight: 900; margin: 0;">J&N SOLUCIONES</h2>
                    <p style="color: #666; font-size: 11px; margin: 3px 0 0 0;">Comprobante Oficial de Transacción</p>
                </div>
                
                <div style="line-height: 1.6; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: #666;">Tipo:</span>
                        <span id="voucher-type" style="font-weight: bold; color: #002d5e;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: #666;">Cliente:</span>
                        <span id="voucher-client" style="font-weight: bold; text-align: right; max-width: 60%;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: #666;">Monto:</span>
                        <span id="voucher-amount" style="font-weight: bold; color: #002d5e;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: #666;">Interés:</span>
                        <span id="voucher-interest" style="font-weight: bold; color: #10b981;"></span>
                    </div>
                    <div style="border-top: 2px solid #eee; padding-top: 8px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span style="color: #666;">Saldo Pendiente:</span>
                            <span id="voucher-balance" style="font-weight: 900; color: #ef4444;"></span>
                        </div>
                    </div>
                    <div style="background: rgba(0, 45, 94, 0.05); padding: 10px; border-radius: 8px; margin-top: 12px; border: 1px solid rgba(0, 45, 94, 0.1);">
                        <p style="color: #666; font-size: 11px; margin: 0 0 3px 0;">Próximo Pago:</p>
                        <p id="voucher-next-date" style="font-weight: bold; margin: 0; color: #1f2937; font-size: 13px;"></p>
                        <p id="voucher-next-amount" style="color: #ef4444; font-weight: bold; margin: 3px 0 0 0; font-size: 12px;"></p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid #eee; font-size: 9px; color: #999;">
                    <p id="voucher-date" style="margin: 0;"></p>
                    <p style="margin: 3px 0 0 0;">Validado por Sistema J&N PRO</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBXHcdK3FtNjXXYwSWhyXt35-eBZ1Rtk8U",
            authDomain: "jn-soluciones-2026.firebaseapp.com",
            projectId: "jn-soluciones-2026",
            databaseURL: "https://jn-soluciones-2026-default-rtdb.firebaseio.com",
            storageBucket: "jn-soluciones-2026.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        let app, db, auth;
        let firebaseConnected = false;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            firebaseConnected = true;
        } catch (e) {
            console.error('Firebase init error:', e);
        }

        // App State
        let appData = {
            clients: [],
            loans: [],
            payments: [],
            blacklist: [],
            vouchers: [],
            settings: { interestRate: 10, pin: '0417' }
        };

        let currentUser = null;
        let charts = {};
        let isOffline = false;
        let syncQueue = [];
        let currentPin = '';
        let currentVoucherBlob = null;
        let isMoreMenuOpen = false;

        // PIN Functions
        function enterPin(digit) {
            if (currentPin.length < 4) {
                currentPin += digit;
                updatePinDisplay();
                
                if (currentPin.length === 4) {
                    setTimeout(validatePin, 200);
                }
            }
        }

        function deletePin() {
            if (currentPin.length > 0) {
                currentPin = currentPin.slice(0, -1);
                updatePinDisplay();
            }
        }

        function clearPin() {
            currentPin = '';
            updatePinDisplay();
            document.querySelectorAll('.pin-dot').forEach(dot => dot.classList.remove('error'));
            document.getElementById('pin-error').style.opacity = '0';
        }

        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin-${i}`);
                if (i <= currentPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        function validatePin() {
            const savedPin = appData.settings?.pin || '0417';
            
            if (currentPin === savedPin) {
                currentUser = { uid: 'local', name: 'Administrador' };
                document.getElementById('user-name').textContent = 'Admin';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('app-content').classList.add('flex');
                initApp();
                showToast('Bienvenido', 'success');
            } else {
                document.querySelectorAll('.pin-dot').forEach(dot => {
                    dot.classList.remove('filled');
                    dot.classList.add('error');
                });
                document.getElementById('pin-error').style.opacity = '1';
                currentPin = '';
                setTimeout(() => {
                    document.querySelectorAll('.pin-dot').forEach(dot => dot.classList.remove('error'));
                    document.getElementById('pin-error').style.opacity = '0';
                }, 1000);
            }
        }

        function changePin() {
            const current = document.getElementById('current-pin').value;
            const newPin = document.getElementById('new-pin').value;
            const confirm = document.getElementById('confirm-pin').value;
            const savedPin = appData.settings?.pin || '0417';
            
            if (current !== savedPin) {
                showToast('PIN actual incorrecto', 'error');
                return;
            }
            
            if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                showToast('El PIN debe ser de 4 dígitos numéricos', 'error');
                return;
            }
            
            if (newPin !== confirm) {
                showToast('Los PINs no coinciden', 'error');
                return;
            }
            
            appData.settings.pin = newPin;
            saveData();
            showToast('PIN cambiado exitosamente', 'success');
            
            document.getElementById('current-pin').value = '';
            document.getElementById('new-pin').value = '';
            document.getElementById('confirm-pin').value = '';
        }

        // More Menu Toggle
        function toggleMoreMenu() {
            const modal = document.getElementById('modal-more');
            const btnMore = document.getElementById('btn-more');
            
            if (isMoreMenuOpen) {
                // Close menu
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                btnMore.classList.remove('text-accent');
                btnMore.classList.add('text-gray-400');
                isMoreMenuOpen = false;
            } else {
                // Open menu
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                btnMore.classList.add('text-accent');
                btnMore.classList.remove('text-gray-400');
                isMoreMenuOpen = true;
            }
        }

        function handleMoreBackdropClick(event) {
            if (event.target === event.currentTarget) {
                toggleMoreMenu();
            }
        }

        // Network Status
        function updateOnlineStatus() {
            isOffline = !navigator.onLine;
            const indicator = document.getElementById('offline-indicator');
            const statusDot = document.getElementById('sync-status-dot');
            const statusText = document.getElementById('sync-status-text');
            
            if (isOffline) {
                indicator.classList.add('show');
                statusDot.classList.remove('bg-success', 'pulse-ring');
                statusDot.classList.add('bg-warning');
                statusText.textContent = 'Offline';
            } else {
                indicator.classList.remove('show');
                statusDot.classList.add('bg-success', 'pulse-ring');
                statusDot.classList.remove('bg-warning');
                statusText.textContent = 'Sincronizado';
                if (syncQueue.length > 0) {
                    processSyncQueue();
                }
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function loginDemo() {
            currentUser = { uid: 'demo', name: 'Demo' };
            document.getElementById('user-name').textContent = 'Modo Demo';
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('app-content').classList.add('flex');
            initApp();
            showToast('Modo demo activado', 'info');
        }

        function logout() {
            localStorage.removeItem('jn_pro_current_user');
            location.reload();
        }

        // Initialize App
        function initApp() {
            updateOnlineStatus();
            loadLocalData();
            
            if (firebaseConnected && navigator.onLine) {
                loadFromFirebase();
                setupRealtimeSync();
            }
            
            setDefaultDates();
            renderVouchersList();
            
            if (currentUser) {
                localStorage.setItem('jn_pro_current_user', JSON.stringify({
                    uid: currentUser.uid || 'local',
                    name: currentUser.name || 'Admin'
                }));
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            document.getElementById('new-loan-date').value = today;
            document.getElementById('payment-next-date').value = nextWeek.toISOString().split('T')[0];
        }

        // Data Management
        function loadLocalData() {
            const saved = localStorage.getItem('jn_pro_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    appData = { ...appData, ...data };
                    updateUI();
                } catch (e) {
                    console.error('Error loading local data:', e);
                }
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('jn_pro_data', JSON.stringify(appData));
                appData.lastSync = new Date().toISOString();
            } catch (e) {
                console.error('Error saving local data:', e);
            }
        }

        function loadFromFirebase() {
            if (!db) return;
            
            db.ref('jn_pro_2026').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        appData = {
                            ...appData,
                            ...data,
                            clients: mergeArrays(appData.clients, data.clients || []),
                            loans: mergeArrays(appData.loans, data.loans || []),
                            payments: mergeArrays(appData.payments, data.payments || []),
                            blacklist: mergeArrays(appData.blacklist, data.blacklist || []),
                            vouchers: data.vouchers || appData.vouchers || []
                        };
                        updateUI();
                        saveLocalData();
                    }
                })
                .catch((err) => {
                    console.error('Firebase load error:', err);
                });
        }

        function mergeArrays(local, remote) {
            const merged = [...local];
            const localIds = new Set(local.map(i => i.id));
            remote.forEach(item => {
                if (!localIds.has(item.id)) {
                    merged.push(item);
                }
            });
            return merged;
        }

        function setupRealtimeSync() {
            if (!db || !navigator.onLine) return;
            
            db.ref('jn_pro_2026').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && !isOffline) {
                    appData = { ...appData, ...data };
                    updateUI();
                }
            }, (err) => {
                console.error('Sync error:', err);
            });
        }

        function saveData() {
            saveLocalData();
            
            if (isOffline || !firebaseConnected) {
                syncQueue.push({ action: 'save', data: appData });
                return;
            }
            
            if (db) {
                db.ref('jn_pro_2026').set(appData)
                    .then(() => {
                        document.getElementById('sync-status-text').textContent = 'Sincronizado';
                    })
                    .catch((err) => {
                        console.error('Firebase save error:', err);
                        document.getElementById('sync-status-text').textContent = 'Error sync';
                        syncQueue.push({ action: 'save', data: appData });
                    });
            }
        }

        function processSyncQueue() {
            if (!navigator.onLine || !db || syncQueue.length === 0) return;
            
            showToast('Sincronizando datos...', 'info');
            
            const promises = syncQueue.map(item => {
                return db.ref('jn_pro_2026').set(item.data);
            });
            
            Promise.all(promises)
                .then(() => {
                    syncQueue = [];
                    showToast('Sincronización completada', 'success');
                })
                .catch((err) => {
                    console.error('Sync queue error:', err);
                });
        }

        // UI Updates
        function updateUI() {
            updateStats();
            updateCharts();
            renderClients();
            renderLoans();
            renderPayments();
            renderBlacklist();
            updateSelects();
            renderRecentActivity();
        }

        function updateStats() {
            const activeLoans = appData.loans.filter(l => !l.paid);
            const capital = activeLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const profits = appData.payments.reduce((sum, p) => sum + (parseFloat(p.interest) || 0), 0);
            const activeClients = new Set(activeLoans.map(l => l.clientId)).size;
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const overdue = activeLoans.filter(l => {
                if (!l.nextPaymentDate) return false;
                const nextDate = new Date(l.nextPaymentDate);
                nextDate.setHours(0,0,0,0);
                return nextDate < today;
            }).length;

            document.getElementById('stat-capital').textContent = formatCurrency(capital);
            document.getElementById('stat-profits').textContent = formatCurrency(profits);
            document.getElementById('stat-clients').textContent = activeClients;
            document.getElementById('stat-overdue').textContent = overdue;
        }

        function updateCharts() {
            if (window.innerWidth < 768) {
                setTimeout(() => {
                    updateEvolutionChart();
                    updateDistributionChart();
                }, 100);
            } else {
                updateEvolutionChart();
                updateDistributionChart();
            }
        }

        function updateEvolutionChart() {
            const ctx = document.getElementById('chart-evolution');
            if (!ctx) return;

            const last7Days = [];
            const profits = [];
            const capital = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                last7Days.push(date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
                
                const dayProfits = appData.payments
                    .filter(p => p.date === dateStr)
                    .reduce((sum, p) => sum + (parseFloat(p.interest) || 0), 0);
                profits.push(dayProfits);

                const dayCapital = appData.loans
                    .filter(l => l.date === dateStr && !l.paid)
                    .reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                capital.push(dayCapital);
            }

            if (charts.evolution) {
                charts.evolution.destroy();
            }

            charts.evolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Ganancias',
                        data: profits,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        borderWidth: 2
                    }, {
                        label: 'Capital',
                        data: capital,
                        borderColor: '#00a8e8',
                        backgroundColor: 'rgba(0, 168, 232, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { 
                            labels: { color: '#fff', font: { size: 11 } } 
                        } 
                    },
                    scales: {
                        y: { 
                            ticks: { color: '#9ca3af', font: { size: 10 } }, 
                            grid: { color: '#334155' } 
                        },
                        x: { 
                            ticks: { color: '#9ca3af', font: { size: 10 } }, 
                            grid: { color: '#334155' } 
                        }
                    }
                }
            });
        }

        function updateDistributionChart() {
            const ctx = document.getElementById('chart-distribution');
            if (!ctx) return;

            const active = appData.loans.filter(l => !l.paid).reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const paid = appData.loans.filter(l => l.paid).reduce((sum, l) => sum + (parseFloat(l.originalAmount) || parseFloat(l.amount) || 0), 0);
            const lost = appData.blacklist.reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);

            if (charts.distribution) {
                charts.distribution.destroy();
            }

            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Activo', 'Recuperado', 'Pérdidas'],
                    datasets: [{
                        data: [active, paid, lost],
                        backgroundColor: ['#00a8e8', '#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { color: '#fff', font: { size: 11 }, padding: 15 } 
                        } 
                    }
                }
            });
        }

        function renderRecentActivity() {
            const container = document.getElementById('recent-activity');
            const recent = [...appData.payments].sort((a,b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)).slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay actividad reciente</p>';
                return;
            }
            
            container.innerHTML = recent.map(p => {
                const client = appData.clients.find(c => c.id === p.clientId);
                return `
                    <div class="flex items-center justify-between p-3 bg-surface rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-success/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-arrow-down text-success"></i>
                            </div>
                            <div>
                                <p class="font-medium text-sm">${client?.name || p.clientName || 'Cliente'}</p>
                                <p class="text-xs text-gray-500">${formatDate(p.date)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-success text-sm">+${formatCurrency(p.interest)}</p>
                            <p class="text-xs text-gray-500">Interés</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Client Functions
        function renderClients() {
            const grid = document.getElementById('clients-grid');
            const searchTerm = (document.getElementById('search-clients')?.value || '').toLowerCase();
            
            let clients = appData.clients;
            if (searchTerm) {
                clients = clients.filter(c => 
                    (c.name || '').toLowerCase().includes(searchTerm) || 
                    (c.idCard || '').toLowerCase().includes(searchTerm) ||
                    (c.phone || '').includes(searchTerm)
                );
            }

            grid.innerHTML = clients.map(client => {
                const clientLoans = appData.loans.filter(l => l.clientId === client.id && !l.paid);
                const totalDebt = clientLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const isBlacklisted = appData.blacklist.some(b => b.clientId === client.id);
                
                return `
                    <div class="glass-effect rounded-2xl p-4 md:p-6 card-hover touch-feedback" onclick="viewClientLoans('${client.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-accent to-primary rounded-xl flex items-center justify-center text-lg md:text-xl font-bold">
                                ${(client.name || '?').charAt(0).toUpperCase()}
                            </div>
                            <span class="status-badge ${isBlacklisted ? 'status-blacklist' : (totalDebt > 0 ? 'status-active' : 'bg-gray-700 text-gray-300')} text-xs">
                                ${isBlacklisted ? 'Bloqueado' : (totalDebt > 0 ? 'Activo' : 'Al día')}
                            </span>
                        </div>
                        <h4 class="font-bold text-base md:text-lg mb-1 truncate">${client.name || 'Sin nombre'}</h4>
                        <p class="text-xs md:text-sm text-gray-400 mb-2">${client.idCard || 'Sin cédula'}</p>
                        <div class="flex items-center gap-2 text-xs md:text-sm text-gray-400 mb-3">
                            <i class="fas fa-phone text-xs"></i> ${client.phone || 'Sin teléfono'}
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-gray-700">
                            <div>
                                <p class="text-[10px] md:text-xs text-gray-500">Deuda Total</p>
                                <p class="font-bold text-sm md:text-base ${totalDebt > 0 ? 'text-danger' : 'text-success'}">${formatCurrency(totalDebt)}</p>
                            </div>
                            <button class="px-3 py-1.5 bg-accent/20 text-accent rounded-lg text-xs md:text-sm hover:bg-accent/30">
                                Ver
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center col-span-full py-8">No hay clientes registrados</p>';
        }

        function searchClients() {
            renderClients();
        }

        function viewClientLoans(clientId) {
            const client = appData.clients.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('search-clients').value = client.name;
            renderClients();
            
            showPage('loans');
        }

        function saveNewClient() {
            const name = document.getElementById('new-client-name').value.trim();
            const idCard = document.getElementById('new-client-id').value.trim();
            const phone = document.getElementById('new-client-phone').value.trim();
            const address = document.getElementById('new-client-address').value.trim();

            if (!name) {
                showToast('Ingrese el nombre del cliente', 'error');
                return;
            }
            
            if (!phone) {
                showToast('Ingrese el teléfono del cliente', 'error');
                return;
            }

            const newClient = {
                id: Date.now().toString(),
                name: name.toUpperCase(),
                idCard,
                phone,
                address,
                createdAt: new Date().toISOString()
            };

            appData.clients.push(newClient);
            saveData();
            closeModal('modal-new-client');
            showToast('Cliente guardado exitosamente', 'success');
            clearModalInputs('modal-new-client');
            renderClients();
        }

        // Loan Functions
        function renderLoans() {
            const grid = document.getElementById('loans-grid');
            const filter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            
            let loans = appData.loans.filter(l => !l.paid);
            
            if (filter === 'overdue') {
                const today = new Date();
                today.setHours(0,0,0,0);
                loans = loans.filter(l => {
                    if (!l.nextPaymentDate) return false;
                    const nextDate = new Date(l.nextPaymentDate);
                    nextDate.setHours(0,0,0,0);
                    return nextDate < today;
                });
            }

            grid.innerHTML = loans.map(loan => {
                const client = appData.clients.find(c => c.id === loan.clientId);
                const today = new Date();
                today.setHours(0,0,0,0);
                const isOverdue = loan.nextPaymentDate ? new Date(loan.nextPaymentDate) < today : false;
                const interest = Math.round((parseFloat(loan.amount) || 0) * (parseFloat(loan.interestRate) || 10) / 100);

                return `
                    <div class="glass-effect rounded-2xl p-4 md:p-6 card-hover ${isOverdue ? 'border border-danger/50' : ''}">
                        <div class="flex items-start justify-between mb-3 md:mb-4">
                            <div class="min-w-0 flex-1">
                                <h4 class="font-bold text-base md:text-lg truncate">${client?.name || 'Cliente eliminado'}</h4>
                                <p class="text-xs md:text-sm text-gray-400">#${loan.id.slice(-6)}</p>
                            </div>
                            <span class="status-badge ${isOverdue ? 'status-overdue' : 'status-active'} text-xs ml-2">
                                ${isOverdue ? 'Vencido' : 'Activo'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 md:gap-4 mb-3 md:mb-4 text-sm">
                            <div>
                                <p class="text-[10px] md:text-xs text-gray-500">Capital</p>
                                <p class="font-bold text-sm md:text-base truncate-number">${formatCurrency(loan.amount)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] md:text-xs text-gray-500">Interés</p>
                                <p class="font-bold text-success text-sm md:text-base truncate-number">${formatCurrency(interest)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] md:text-xs text-gray-500">Próximo</p>
                                <p class="font-bold text-xs md:text-sm ${isOverdue ? 'text-danger' : ''}">${formatDate(loan.nextPaymentDate)}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="viewLoanDetails('${loan.id}')" class="flex-1 px-3 py-2 bg-surface rounded-lg text-xs md:text-sm hover:bg-gray-700 touch-feedback">
                                <i class="fas fa-eye mr-1"></i> Ver
                            </button>
                            <button onclick="quickPay('${loan.id}')" class="flex-1 px-3 py-2 btn-gradient rounded-lg text-xs md:text-sm font-bold touch-feedback">
                                <i class="fas fa-money-bill-wave mr-1"></i> Cobrar
                            </button>
                            <button onclick="addToBlacklist('${loan.id}')" class="px-3 py-2 bg-danger/20 text-danger rounded-lg text-xs md:text-sm hover:bg-danger/30 touch-feedback" title="Bloquear">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-8">No hay préstamos activos</p>';
        }

        function filterLoans(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-accent/20', 'text-accent');
                btn.classList.add('bg-surface', 'text-gray-400');
            });
            
            const activeBtn = document.querySelector(`[data-filter="${type}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-accent/20', 'text-accent');
                activeBtn.classList.remove('bg-surface', 'text-gray-400');
            }
            
            renderLoans();
        }

        function saveNewLoan() {
            const clientId = document.getElementById('new-loan-client').value;
            const amount = parseFloat(document.getElementById('new-loan-amount').value);
            const rate = parseFloat(document.getElementById('new-loan-rate').value) || 10;
            const date = document.getElementById('new-loan-date').value;
            const notes = document.getElementById('new-loan-notes').value;

            if (!clientId) {
                showToast('Seleccione un cliente', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Ingrese un monto válido', 'error');
                return;
            }
            
            if (!date) {
                showToast('Seleccione una fecha de pago', 'error');
                return;
            }

            const client = appData.clients.find(c => c.id === clientId);
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }
            
            const newLoan = {
                id: Date.now().toString(),
                clientId,
                clientName: client.name,
                amount: amount,
                originalAmount: amount,
                interestRate: rate,
                nextPaymentDate: date,
                notes,
                date: new Date().toISOString().split('T')[0],
                paid: false,
                createdAt: new Date().toISOString()
            };

            appData.loans.push(newLoan);
            saveData();
            closeModal('modal-new-loan');
            showToast('Préstamo creado exitosamente', 'success');
            clearModalInputs('modal-new-loan');
            
            setTimeout(() => {
                generateVoucher('APERTURA DE CRÉDITO', client.name, amount, 0, amount, date);
            }, 500);
        }

        function viewLoanDetails(loanId) {
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            const client = appData.clients.find(c => c.id === loan.clientId);
            const payments = appData.payments.filter(p => p.loanId === loanId).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const content = document.getElementById('loan-details-content');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-surface rounded-xl p-4">
                        <p class="text-xs text-gray-400">Cliente</p>
                        <p class="font-bold text-lg">${client?.name || 'N/A'}</p>
                        <p class="text-sm text-gray-400">${client?.phone || ''}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-surface rounded-xl p-3">
                            <p class="text-xs text-gray-400">Monto Original</p>
                            <p class="font-bold truncate-number">${formatCurrency(loan.originalAmount || loan.amount)}</p>
                        </div>
                        <div class="bg-surface rounded-xl p-3">
                            <p class="text-xs text-gray-400">Saldo Actual</p>
                            <p class="font-bold ${loan.amount > 0 ? 'text-danger' : 'text-success'} truncate-number">${formatCurrency(loan.amount)}</p>
                        </div>
                        <div class="bg-surface rounded-xl p-3">
                            <p class="text-xs text-gray-400">Tasa</p>
                            <p class="font-bold">${loan.interestRate || 10}%</p>
                        </div>
                        <div class="bg-surface rounded-xl p-3">
                            <p class="text-xs text-gray-400">Próximo Pago</p>
                            <p class="font-bold">${formatDate(loan.nextPaymentDate)}</p>
                        </div>
                    </div>
                    
                    ${loan.notes ? `
                        <div class="bg-surface rounded-xl p-3">
                            <p class="text-xs text-gray-400">Notas</p>
                            <p class="text-sm">${loan.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="bg-surface rounded-xl p-4">
                        <p class="text-xs text-gray-400 mb-3">Historial de Pagos (${payments.length})</p>
                        ${payments.length > 0 ? `
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${payments.map(p => `
                                    <div class="flex justify-between items-center p-2 bg-dark rounded-lg text-sm">
                                        <div>
                                            <span class="text-gray-300">${formatDate(p.date)}</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-success">+${formatCurrency(p.interest || 0)} int.</div>
                                            ${p.capital > 0 ? `<div class="text-accent">- ${formatCurrency(p.capital)} cap.</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500 text-sm">Sin pagos registrados</p>'}
                    </div>
                    
                    <button onclick="quickPay('${loan.id}'); closeModal('modal-loan-details');" class="w-full btn-gradient py-3 rounded-xl font-bold text-white touch-feedback">
                        <i class="fas fa-money-bill-wave mr-2"></i> Registrar Pago
                    </button>
                </div>
            `;
            
            openModal('modal-loan-details');
        }

        // Payment Functions
        function updateSelects() {
            const clientSelect = document.getElementById('payment-client');
            const loanClientSelect = document.getElementById('new-loan-client');
            
            const activeClients = appData.clients.filter(c => {
                const hasLoans = appData.loans.some(l => l.clientId === c.id && !l.paid);
                return hasLoans || appData.loans.filter(l => l.clientId === c.id).length === 0;
            });
            
            const clientOptions = activeClients.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
            
            if (clientSelect) {
                clientSelect.innerHTML = '<option value="">Seleccionar...</option>' + clientOptions;
            }
            if (loanClientSelect) {
                loanClientSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + 
                    appData.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        function loadClientLoans() {
            const clientId = document.getElementById('payment-client').value;
            const loanSelect = document.getElementById('payment-loan');
            
            if (!clientId) {
                loanSelect.innerHTML = '<option value="">Seleccionar...</option>';
                return;
            }
            
            const loans = appData.loans.filter(l => l.clientId === clientId && !l.paid);
            loanSelect.innerHTML = '<option value="">Seleccionar préstamo...</option>' + 
                loans.map(l => `<option value="${l.id}">${formatCurrency(l.amount)} - Vence ${formatDate(l.nextPaymentDate)}</option>`).join('');
            
            document.getElementById('payment-interest').value = '';
            document.getElementById('payment-capital').value = '';
        }

        function calculatePayment() {
            const loanId = document.getElementById('payment-loan').value;
            if (!loanId) return;
            
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            const interest = Math.round((parseFloat(loan.amount) || 0) * (parseFloat(loan.interestRate) || 10) / 100);
            
            document.getElementById('payment-interest').value = interest;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('payment-next-date').value = nextWeek.toISOString().split('T')[0];
        }

        function processPayment() {
            const loanId = document.getElementById('payment-loan').value;
            const interest = parseFloat(document.getElementById('payment-interest').value) || 0;
            const capital = parseFloat(document.getElementById('payment-capital').value) || 0;
            const nextDate = document.getElementById('payment-next-date').value;
            
            if (!loanId) {
                showToast('Seleccione un préstamo', 'error');
                return;
            }
            
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) {
                showToast('Préstamo no encontrado', 'error');
                return;
            }
            
            const client = appData.clients.find(c => c.id === loan.clientId);
            
            if (capital > loan.amount) {
                showToast('El abono no puede exceder el saldo', 'error');
                return;
            }
            
            const newAmount = loan.amount - capital;
            loan.amount = newAmount;
            if (nextDate) {
                loan.nextPaymentDate = nextDate;
            }
            
            if (loan.amount <= 0) {
                loan.paid = true;
                loan.amount = 0;
                loan.paidAt = new Date().toISOString();
            }
            
            const payment = {
                id: Date.now().toString(),
                loanId,
                clientId: loan.clientId,
                clientName: client?.name || loan.clientName || 'Cliente',
                interest,
                capital,
                balance: newAmount,
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };
            
            appData.payments.push(payment);
            saveData();
            
            showToast(loan.paid ? 'Préstamo liquidado' : 'Pago registrado', 'success');
            
            const type = loan.paid ? 'LIQUIDACIÓN' : 'RECIBO DE PAGO';
            generateVoucher(type, client?.name || loan.clientName, capital, interest, newAmount, nextDate);
            
            document.getElementById('payment-client').value = '';
            document.getElementById('payment-loan').innerHTML = '<option value="">Seleccionar...</option>';
            document.getElementById('payment-interest').value = '';
            document.getElementById('payment-capital').value = '';
            
            updateUI();
        }

        function quickPay(loanId) {
            showPage('payments');
            setTimeout(() => {
                document.getElementById('payment-loan').value = loanId;
                const loan = appData.loans.find(l => l.id === loanId);
                if (loan) {
                    document.getElementById('payment-client').value = loan.clientId;
                    loadClientLoans();
                    setTimeout(() => {
                        document.getElementById('payment-loan').value = loanId;
                        calculatePayment();
                    }, 100);
                }
            }, 300);
        }

        function renderPayments() {
            const tbody = document.getElementById('payments-table-body');
            const recentPayments = [...appData.payments].sort((a,b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)).slice(0, 50);
            
            tbody.innerHTML = recentPayments.map(p => `
                <tr class="border-b border-gray-700 text-sm">
                    <td class="py-3">${formatDate(p.date)}</td>
                    <td class="py-3">${p.clientName}</td>
                    <td class="py-3 text-success">+${formatCurrency(p.interest)}</td>
                    <td class="py-3">${formatCurrency(p.capital)}</td>
                    <td class="py-3 font-bold truncate-number">${formatCurrency(p.balance)}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="py-8 text-center text-gray-500">No hay pagos registrados</td></tr>';
        }

        // Blacklist Functions
        function addToBlacklist(loanId) {
            if (!confirm('¿Mover este cliente a la lista negra? Se marcará como moroso.')) return;
            
            const loanIndex = appData.loans.findIndex(l => l.id === loanId);
            if (loanIndex === -1) return;
            
            const loan = appData.loans[loanIndex];
            
            appData.loans.splice(loanIndex, 1);
            
            appData.blacklist.push({
                ...loan,
                blacklistedAt: new Date().toISOString(),
                reason: 'Morosidad'
            });
            
            saveData();
            showToast('Cliente bloqueado', 'warning');
            updateUI();
        }

        function removeFromBlacklist(blacklistId) {
            if (!confirm('¿Restaurar este cliente?')) return;
            
            const index = appData.blacklist.findIndex(b => b.id === blacklistId);
            if (index === -1) return;
            
            const item = appData.blacklist[index];
            appData.blacklist.splice(index, 1);
            
            if (!item.paid) {
                appData.loans.push(item);
            }
            
            saveData();
            showToast('Cliente restaurado', 'success');
            updateUI();
        }

        function renderBlacklist() {
            const grid = document.getElementById('blacklist-grid');
            
            grid.innerHTML = appData.blacklist.map(item => {
                const client = appData.clients.find(c => c.id === item.clientId);
                return `
                    <div class="glass-effect rounded-2xl p-4 md:p-6 border border-danger/30">
                        <div class="flex items-start justify-between mb-3 md:mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 md:w-12 md:h-12 bg-danger/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-ban text-danger text-lg"></i>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="font-bold text-sm md:text-base truncate">${client?.name || item.clientName || 'Cliente eliminado'}</h4>
                                    <p class="text-xs text-gray-400">Bloqueado: ${formatDate(item.blacklistedAt)}</p>
                                </div>
                            </div>
                            <span class="text-danger font-bold text-sm md:text-base truncate-number">${formatCurrency(item.amount)}</span>
                        </div>
                        <button onclick="removeFromBlacklist('${item.id}')" class="w-full px-4 py-2 bg-success/20 text-success rounded-lg text-sm hover:bg-success/30 touch-feedback">
                            <i class="fas fa-check mr-2"></i> Restaurar Cliente
                        </button>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-8">Lista negra vacía</p>';
        }

        // Voucher Generation - Optimized for mobile
        async function generateVoucher(type, client, amount, interest, balance, nextDate) {
            try {
                // Update voucher content
                document.getElementById('voucher-type').textContent = type;
                document.getElementById('voucher-client').textContent = (client || 'N/A').toUpperCase();
                document.getElementById('voucher-amount').textContent = formatCurrency(amount);
                document.getElementById('voucher-interest').textContent = formatCurrency(interest);
                document.getElementById('voucher-balance').textContent = formatCurrency(balance);
                document.getElementById('voucher-next-date').textContent = nextDate ? formatDate(nextDate) : 'N/A';
                document.getElementById('voucher-next-amount').textContent = balance > 0 ? 'Cuota: ' + formatCurrency(Math.round(balance * 0.1)) : 'COMPLETADO';
                document.getElementById('voucher-date').textContent = new Date().toLocaleString('es-ES');
                
                const voucherTemplate = document.getElementById('voucher-template');
                const voucherEl = document.getElementById('voucher-element');
                
                // Make visible for capture
                voucherTemplate.classList.remove('hidden');
                voucherTemplate.style.opacity = '1';
                voucherTemplate.style.position = 'fixed';
                voucherTemplate.style.top = '0';
                voucherTemplate.style.left = '0';
                voucherTemplate.style.zIndex = '-1';
                
                // Wait for render
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Use html2canvas with mobile-friendly options
                const canvas = await html2canvas(voucherEl, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: 350,
                    height: voucherEl.offsetHeight
                });
                
                // Hide again
                voucherTemplate.classList.add('hidden');
                voucherTemplate.style.opacity = '0';
                
                // Convert to blob for better mobile compatibility
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showToast('Error generando voucher', 'error');
                        return;
                    }
                    
                    currentVoucherBlob = blob;
                    const fileName = `VOUCHER_${(client || 'CLIENTE').replace(/\s+/g, '_')}_${Date.now()}.png`;
                    
                    // Store voucher in appData
                    const voucherData = {
                        id: Date.now().toString(),
                        type,
                        client: client || 'N/A',
                        amount,
                        interest,
                        balance,
                        nextDate,
                        date: new Date().toISOString(),
                        fileName
                    };
                    
                    appData.vouchers.unshift(voucherData);
                    saveData();
                    renderVouchersList();
                    
                    // Show preview modal
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(blob);
                    img.className = 'max-w-full h-auto rounded-lg';
                    img.style.maxHeight = '60vh';
                    
                    const container = document.getElementById('voucher-preview-container');
                    container.innerHTML = '';
                    container.appendChild(img);
                    
                    openModal('modal-voucher-preview');
                    
                    // Try native sharing first (mobile)
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
                        try {
                            await navigator.share({
                                files: [new File([blob], fileName, { type: 'image/png' })],
                                title: 'Comprobante J&N Soluciones',
                                text: `${type} - ${client}`
                            });
                            showToast('Voucher compartido', 'success');
                        } catch (err) {
                            // User cancelled or failed, preview is already shown
                        }
                    }
                }, 'image/png');
                
            } catch (err) {
                console.error('Voucher error:', err);
                document.getElementById('voucher-template').classList.add('hidden');
                showToast('Error al generar voucher', 'error');
            }
        }

        function downloadCurrentVoucher() {
            if (!currentVoucherBlob) return;
            
            const fileName = `VOUCHER_${Date.now()}.png`;
            downloadBlob(currentVoucherBlob, fileName);
            showToast('Voucher descargado', 'success');
        }

        async function shareCurrentVoucher() {
            if (!currentVoucherBlob) return;
            
            const fileName = `VOUCHER_${Date.now()}.png`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        files: [new File([currentVoucherBlob], fileName, { type: 'image/png' })],
                        title: 'Comprobante J&N Soluciones',
                        text: 'Voucher de transacción'
                    });
                    showToast('Voucher compartido', 'success');
                } catch (err) {
                    showToast('Error al compartir', 'error');
                }
            } else {
                showToast('Compartir no disponible en este dispositivo', 'warning');
            }
        }

        function renderVouchersList() {
            const list = document.getElementById('vouchers-list');
            const noVouchers = document.getElementById('no-vouchers');
            
            if (appData.vouchers.length === 0) {
                list.innerHTML = '';
                noVouchers.classList.remove('hidden');
                return;
            }
            
            noVouchers.classList.add('hidden');
            
            list.innerHTML = appData.vouchers.slice(0, 20).map(v => `
                <div class="voucher-thumb" onclick="regenerateVoucher('${v.id}')">
                    <i class="fas fa-file-invoice"></i>
                    <span class="truncate w-full">${v.type}</span>
                    <span class="text-[10px] text-gray-500">${formatDate(v.date)}</span>
                    <span class="text-accent font-bold text-xs">${formatCurrency(v.amount)}</span>
                </div>
            `).join('');
        }

        function regenerateVoucher(voucherId) {
            const voucher = appData.vouchers.find(v => v.id === voucherId);
            if (!voucher) return;
            
            // Regenerate the voucher with stored data
            generateVoucher(voucher.type, voucher.client, voucher.amount, voucher.interest, voucher.balance, voucher.nextDate);
        }

        function generateTestVoucher() {
            generateVoucher('TEST', 'CLIENTE DE PRUEBA', 1000, 100, 900, new Date().toISOString().split('T')[0]);
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Reports
        function generateReport(type) {
            const content = document.getElementById('report-content');
            const dataDiv = document.getElementById('report-data');
            const title = document.getElementById('report-title');
            
            content.classList.remove('hidden');
            
            let startDate = new Date();
            let endDate = new Date();
            
            switch(type) {
                case 'daily':
                    title.textContent = 'Reporte Diario - ' + formatDate(new Date());
                    break;
                case 'weekly':
                    startDate.setDate(startDate.getDate() - 7);
                    title.textContent = 'Reporte Semanal';
                    break;
                case 'monthly':
                    startDate.setDate(1);
                    title.textContent = 'Reporte Mensual - ' + new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    break;
            }
            
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);
            
            const payments = appData.payments.filter(p => {
                const pDate = new Date(p.date);
                return pDate >= startDate && pDate <= endDate;
            });
            
            const totalInterest = payments.reduce((sum, p) => sum + (parseFloat(p.interest) || 0), 0);
            const totalCapital = payments.reduce((sum, p) => sum + (parseFloat(p.capital) || 0), 0);
            
            dataDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3 md:gap-4 mb-4 md:mb-6">
                    <div class="bg-surface rounded-xl p-3 md:p-4">
                        <p class="text-xs md:text-sm text-gray-400">Total Intereses</p>
                        <p class="text-xl md:text-2xl font-bold text-success truncate-number">${formatCurrency(totalInterest)}</p>
                    </div>
                    <div class="bg-surface rounded-xl p-3 md:p-4">
                        <p class="text-xs md:text-sm text-gray-400">Capital Recuperado</p>
                        <p class="text-xl md:text-2xl font-bold text-accent truncate-number">${formatCurrency(totalCapital)}</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[500px] text-sm">
                        <thead>
                            <tr class="text-left text-gray-400 border-b border-gray-700">
                                <th class="pb-2">Fecha</th>
                                <th class="pb-2">Cliente</th>
                                <th class="pb-2 text-right">Interés</th>
                                <th class="pb-2 text-right">Capital</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(p => `
                                <tr class="border-b border-gray-800">
                                    <td class="py-2">${formatDate(p.date)}</td>
                                    <td class="py-2">${p.clientName}</td>
                                    <td class="py-2 text-right text-success">${formatCurrency(p.interest)}</td>
                                    <td class="py-2 text-right">${formatCurrency(p.capital)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${payments.length === 0 ? '<p class="text-gray-500 text-center py-8">No hay datos para este período</p>' : ''}
            `;
        }

        function exportReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('J&N SOLUCIONES', 20, 30);
            doc.setFontSize(12);
            doc.text(document.getElementById('report-title').textContent, 20, 45);
            doc.text('Generado: ' + new Date().toLocaleString('es-ES'), 20, 55);
            
            doc.save('reporte_jn.pdf');
            showToast('PDF descargado', 'success');
        }

        async function shareReport() {
            const reportText = document.getElementById('report-title').textContent + '\n\n' + 
                document.getElementById('report-data').innerText;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Reporte J&N Soluciones',
                        text: reportText
                    });
                } catch (err) {
                    // User cancelled
                }
            } else {
                navigator.clipboard.writeText(reportText).then(() => {
                    showToast('Reporte copiado al portapapeles', 'success');
                });
            }
        }

        // Backup & Import
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const fileName = `JN_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
            
            downloadBlob(blob, fileName);
            showToast('Backup descargado', 'success');
        }

        function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!confirm(`¿Importar ${data.clients?.length || 0} clientes y ${data.loans?.length || 0} préstamos? Esto fusionará con los datos existentes.`)) {
                        return;
                    }
                    
                    appData.clients = mergeArrays(appData.clients, data.clients || []);
                    appData.loans = mergeArrays(appData.loans, data.loans || []);
                    appData.payments = mergeArrays(appData.payments, data.payments || []);
                    appData.blacklist = mergeArrays(appData.blacklist, data.blacklist || []);
                    
                    saveData();
                    showToast('Datos importados exitosamente', 'success');
                    updateUI();
                } catch (err) {
                    showToast('Error al importar: archivo inválido', 'error');
                }
            };
            reader.readAsText(file);
        }

        function saveSettings() {
            const rate = parseFloat(document.getElementById('settings-rate').value);
            if (rate < 0 || rate > 100) {
                showToast('Tasa inválida', 'error');
                return;
            }
            appData.settings.interestRate = rate;
            saveData();
            showToast('Configuración guardada', 'success');
        }

        function resetAllData() {
            if (!confirm('¿ELIMINAR TODOS LOS DATOS? Esta acción no se puede deshacer.')) return;
            if (!prompt('Escriba BORRAR para confirmar:') === 'BORRAR') return;
            
            appData = { clients: [], loans: [], payments: [], blacklist: [], vouchers: [], settings: { interestRate: 10, pin: appData.settings.pin } };
            saveData();
            showToast('Todos los datos han sido eliminados', 'warning');
            updateUI();
        }

        // Navigation
        function showPage(page) {
            if (page === 'more') {
                toggleMoreMenu();
                return;
            }
            
            // Close more menu if open
            if (isMoreMenuOpen) {
                toggleMoreMenu();
            }
            
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            
            // Show selected view
            const pageEl = document.getElementById(`page-${page}`);
            if (pageEl) {
                pageEl.classList.remove('hidden');
                pageEl.classList.add('fade-in');
            }
            
            // Update title
            const titles = {
                dashboard: 'Dashboard',
                clients: 'Clientes',
                loans: 'Préstamos',
                payments: 'Cobros',
                vouchers: 'Comprobantes',
                blacklist: 'Lista Negra',
                reports: 'Reportes',
                settings: 'Configuración'
            };
            document.getElementById('page-title').textContent = titles[page] || 'J&N PRO';
            
            // Update desktop navigation
            document.querySelectorAll('.menu-item').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-400');
            });
            
            const navBtn = document.getElementById(`nav-${page}`);
            if (navBtn) {
                navBtn.classList.add('active');
                navBtn.classList.remove('text-gray-400');
            }
            
            // Update mobile navigation
            document.querySelectorAll('.mobile-nav').forEach(btn => {
                btn.classList.remove('text-accent');
                btn.classList.add('text-gray-400');
            });
            
            const mobileNav = document.querySelector(`.mobile-nav[data-page="${page}"]`);
            if (mobileNav) {
                mobileNav.classList.add('text-accent');
                mobileNav.classList.remove('text-gray-400');
            }
            
            // Update charts if dashboard
            if (page === 'dashboard') {
                setTimeout(updateCharts, 50);
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleMobileMenu() {
            // Simple toggle for mobile sidebar if needed
            // Currently using bottom nav instead
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        }

        function clearModalInputs(modalId) {
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea, #${modalId} select`).forEach(input => {
                if (input.type !== 'button' && input.type !== 'submit') {
                    input.value = '';
                }
            });
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-success/90 border-success text-white',
                error: 'bg-danger/90 border-danger text-white',
                warning: 'bg-warning/90 border-warning text-black',
                info: 'bg-accent/90 border-accent text-white'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.className = `notification flex items-center gap-3 px-4 py-3 rounded-xl border ${colors[type]} backdrop-blur-md shadow-lg pointer-events-auto`;
            toast.innerHTML = `
                <i class="fas ${icons[type]} text-lg"></i>
                <span class="font-medium text-sm">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Utility Functions
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return '$' + num.toLocaleString('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'Fecha inválida';
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return 'N/A';
            }
        }

        // Prevent double-tap zoom on mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle visibility change (save data when app goes to background)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveLocalData();
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved session
            const savedUser = localStorage.getItem('jn_pro_current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('user-name').textContent = currentUser.name || 'Admin';
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('flex');
                    initApp();
                } catch(e) {
                    localStorage.removeItem('jn_pro_current_user');
                }
            }
        });
    </script>
</body>
</html>